<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>day6-1</title>
</head>
<style>
    .postFrame {
        border-top: 1px solid #F2F3F5;
        border-bottom: 1px solid #F2F3F5;
        padding: 15px;
    }

    .posterName {
        font-weight: bold;
        font-size: 14px;
        position: relative;
    }

    .posterSay {
        font-size: 12px;
    }

    .delBtn {
        position: absolute;
        right: 0;
    }

</style>

<body>
    <h1>day6-1 Message Board</h1>
    <hr>
    <div id="welcome" style="display: none">
        <button id="signIn">登入</button>
    </div>
    <div id="member" style="display: none">
        <textarea id="content" cols="60" rows="7"></textarea>
        <button id="post">發佈</button>
    </div>
    <hr>
    <div id="list">Message List
    </div>


    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBgYvQ3Bid9wjTDLcUmxWAEmHWI2X5Vzc4",
            authDomain: "my-first-test-project-227712.firebaseapp.com",
            databaseURL: "https://my-first-test-project-227712.firebaseio.com",
            projectId: "my-first-test-project-227712",
        };
        firebase.initializeApp(config);

        let currentUser = null;

        firebase.auth().onAuthStateChanged(function(user) {
            let wel = document.getElementById("welcome");
            let mem = document.getElementById("member");
            wel.style.display = "none";
            mem.style.display = "none";

            if (user) {
                mem.style.display = "block";
                currentUser = user;
            } else {
                wel.style.display = "block";
                currentUser = null;
            }
        });

        let sibtn = document.getElementById("signIn");
        let postbtn = document.getElementById("post");

        let provider = new firebase.auth.FacebookAuthProvider();
        provider.addScope('user_birthday');

        function signin() {
            firebase.auth().signInWithPopup(provider)
                .then(function(result) {
                    console.log(result);
                })
                .catch(function(error) {
                    var errorCode = error.code;
                    console.log("Error: ", error);
                    console.log("Error code: ", errorCode);
                });
        }
        sibtn.addEventListener("click", signin);


        let ref = firebase.database().ref("/message_board");

        function post() {
            let content = document.getElementById("content");
            let data = {
                user_id: currentUser.uid,
                name: currentUser.displayName,
                content: content.value,
                time: Date.now()
            }
            ref.push(data, function(error) {
                if (error) {
                    console.log("Error: ", error);
                } else {
                    content.value = "";
                }
            });
        }

        function readmsg() {
            ref.on("value", function(sanpshot) {
                let data = [];
                sanpshot.forEach(function(childSnapshot) {
                    //另外製造一個key和childSnapshot內容物同層的物件
                    let datachkpoint = childSnapshot.val();
                    datachkpoint.key = childSnapshot.key
                    data.push(datachkpoint);
                });
                console.log(data);
                showmsg(data);
            });


        }

        function showmsg(data) {
            let list = document.getElementById("list");
            list.textContent = "";
            for (let i = data.length - 1; i >= 0; i--) {
                let el = document.createElement("div");
                let elName = document.createElement("div");
                let elContent = document.createElement("div");

                el.classList.add("postFrame");
                elName.classList.add("posterName");
                elContent.classList.add("posterSay");
                elName.textContent = data[i].name;
                elContent.textContent = data[i].content;

                list.appendChild(el);
                el.appendChild(elName);
                el.appendChild(elContent);

                if (currentUser.uid === data[i].user_id) {
                    let delBtn = document.createElement("button");
                    delBtn.classList.add("delBtn");
                    delBtn.textContent = "Delete";
                    elName.appendChild(delBtn);
                    delBtn.addEventListener("click", function() {
                        let ref = firebase.database().ref("/message_board/" + data[i].key);
                        ref.remove(function(error) {
                            if (error) {
                                console.log("Error: ", error);
                            } else {
                                console.log("remove!");
                            }
                        });
                    });
                }
            }
        }

        function del(key) {
            let ref = firebase.database().ref("/message_board/" + key);
            ref.remove(function(error) {
                if (error) {
                    console.log("Error: ", error);
                } else {
                    console.log("remove!");
                }
            });
        }
        window.addEventListener("load", readmsg);
        postbtn.addEventListener("click", post);

    </script>

</body>

</html>
