<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>day6-1</title>
</head>

<body>
    <h1>day6-1 Message Board</h1>
    <hr>
    <div id="welcome" style="display: none">
        <button id="signIn">登入</button>
    </div>
    <div id="member" style="display: none">
        <textarea id="content" cols="60" rows="7"></textarea>
        <button id="post">發佈</button>
    </div>
    <hr>
    <div id="list">Message List
    </div>


    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.8.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyBgYvQ3Bid9wjTDLcUmxWAEmHWI2X5Vzc4",
            authDomain: "my-first-test-project-227712.firebaseapp.com",
            databaseURL: "https://my-first-test-project-227712.firebaseio.com",
            projectId: "my-first-test-project-227712",
        };
        firebase.initializeApp(config);

        let db = firebase.database(); //建立與資料庫的連線

        let currentUser = null;

        //當使用者的登入狀態改變時，執行此函式
        firebase.auth().onAuthStateChanged(function(user) {
            let welcm = document.getElementById("welcome");
            let membr = document.getElementById("member");
            welcm.style.display = "none";
            membr.style.display = "none";
            if (user) { // User is signed in.
                console.log(user);
                currentUser = user;
                membr.style.display = "block";

            } else { // User is signed out.
                console.log(user);
                currentUser = null;
                welcm.style.display = "block";
            }
        });

        let signInBtn = document.getElementById("signIn");
        let postBtn = document.getElementById("post");
        let provider = new firebase.auth.FacebookAuthProvider();
        provider.addScope("user_birthday"); //預設是姓名、大頭貼、電子郵件

        function signIn() { //使用跳出式登入視窗
            firebase.auth().signInWithPopup(provider)
                .then(function(result) {
                    console.log("login~");
                })
                .catch(function(error) {
                    var errorCode = error.code;
                    console.log("Error: ", error);
                    console.log("Error code: ", errorCode);

                });
        }

        //將留言和留言者資料放入資料庫
        function post() {
            let id = currentUser.uid;
            let name = currentUser.displayName;
            let content = document.getElementById("content");
            let data = {
                user_id: id,
                name: name,
                content: content.value,
                time: Date.now()
            }
            //加入資料庫
            let ref = db.ref("/message_board"); //產生資料路徑
            ref.push(data, function(error) {
                if (error) {
                    console.log("Error: ", error);
                } else {
                    content.value = "";
                    readMsg();
                }
            });
        }

        signInBtn.addEventListener("click", signIn);
        postBtn.addEventListener("click", post);

        function readMsg() {
            let ref = db.ref("/message_board");
            ref.once("value", function(snapshot) {
                console.log(snapshot);
                let data = [];
                //firebase有提供forEach方法，對snapshot物件進行處理
                snapshot.forEach(function(item) {
                    console.log("item: ", item);
                    let msg = item.val();
                    msg.key = item.key;
                    data.push(msg);
                });
                console.log(data);
                show(data);
            });
        }

        let message;

        function show(data) {
            let list = document.getElementById("list");
            list.innerHTML = "";

            for (let i = 0; i < data.length; i++) {
                message = data[i];
                //沒有人登入，僅顯示留言列表
                if (currentUser === null) {
                    list.innerHTML = message.name.bold() + " " + message.content + "<hr>" + list.innerHTML;
                } else {
                    //登入的人和留言的人一樣
                    if (currentUser.uid === message.user_id) {
                        list.innerHTML = message.name.bold() + " " + message.content + "<button onclick='del(\"" + message.key + "\");'>Delete</button>" + "<hr>" + list.innerHTML;
                    } else { //登入的是不同人
                        list.innerHTML = message.name.bold() + " " + message.content + "<hr>" + list.innerHTML;
                    }
                }

            }
            console.log(message);
        }

        //let del = document.getElementById("del");

        function del(key) {
            let ref = db.ref("/message_board/" + key);
            ref.remove(function(error) {
                if (error) {
                    console.log("Error: ", error);
                } else {
                    console.log("remove!");
                    show(data);
                }
            });
        }
        //del.addEventListener("click", del);
        window.addEventListener("load", readMsg);
    </script>

</body>

</html>
